<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <title>Menara Berkembar PETRONAS – AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; --footer-h: 96px; }
    html, body { height:100%; margin:0; background:#000; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; overflow:hidden; }

    /* Poster stage (no crop, zoomable) */
    .stage { position:fixed; left:0; top:0; right:0; height:calc(100vh - var(--footer-h)); background:#000; touch-action:none; overflow:hidden; }
    .poster {
      position:absolute; left:50%; top:50%;
      transform:translate(-50%, -50%) scale(1);
      transform-origin:center center;
      max-width:100%; max-height:100%;
      object-fit:contain; object-position:center;
      will-change:transform; user-select:none; -webkit-user-drag:none; pointer-events:none;
    }

    /* Footer actions (never cover poster) */
    .footer {
      position:fixed; left:0; right:0; bottom:0; height:var(--footer-h);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      background:linear-gradient(180deg, rgba(0,0,0,.0) 0%, rgba(0,0,0,.65) 30%, rgba(0,0,0,.85) 100%);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom, 0px)); text-align:center;
    }
    .hint {
      font-size:13px; color:#fff; opacity:.95;
      text-shadow:0 0 6px rgba(255,255,255,.55), 0 0 12px rgba(43,145,255,.35);
      filter:drop-shadow(0 1px 2px rgba(0,0,0,.6));
    }
    .actions { display:flex; gap:12px; align-items:center; justify-content:center; }

    /* Buttons */
    .btn { appearance:none; border:0; padding:12px 18px; border-radius:9999px; cursor:pointer; font-weight:700;
           background:#2b91ff; color:#fff; box-shadow:0 8px 22px rgba(43,145,255,.35); }
    .link { background:transparent; color:#eaf1ff; opacity:.9; text-decoration:underline; font-weight:600; padding:8px 0; border:0; }

    /* Reset zoom */
    .reset {
      position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top, 0px));
      z-index:2; font-size:12px; color:#cfe2ff; background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12); border-radius:9999px; padding:6px 10px; backdrop-filter:blur(4px);
      cursor:pointer;
    }

    /* Instruction modal (iOS) */
    .modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999;
      background:rgba(0,0,0,.7); backdrop-filter:blur(4px);
    }
    .modal.visible { display:flex; }
    .modal-card {
      background:#111; color:#fff; padding:20px; border-radius:14px; max-width:320px; text-align:center;
      border:1px solid rgba(255,255,255,.2); box-shadow:0 8px 24px rgba(0,0,0,.5);
    }
    .modal svg { width:40px; height:40px; margin-bottom:8px; fill:#fff; filter:drop-shadow(0 0 8px rgba(43,145,255,.5)); }
    .modal p { font-size:15px; margin:10px 0 16px; }
    .modal button { background:#2b91ff; color:#fff; border:0; border-radius:9999px; padding:10px 18px; font-weight:700; cursor:pointer;
                    box-shadow:0 6px 18px rgba(43,145,255,.35); }

    /* === Subtle loader (centered spinner + text) === */
    .loader {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,.3));
      z-index:5; transition:opacity .25s ease;
    }
    .loader.hide { opacity:0; pointer-events:none; }
    .spinner {
      width:28px; height:28px; border-radius:50%;
      border:3px solid rgba(255,255,255,.25); border-top-color:#fff;
      animation:spin 1s linear infinite; margin-right:10px;
    }
    .loading-text { color:#fff; opacity:.9; font-size:14px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media (prefers-reduced-motion: reduce) {
      .spinner { animation:none; border-top-color:rgba(255,255,255,.6); }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader" role="status" aria-live="polite" aria-label="Memuatkan poster">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">Memuatkan…</div>
  </div>

  <!-- Poster -->
  <div id="stage" class="stage">
    <img id="poster" class="poster" src="https://dhukanestapha.github.io/kl-ar/assets/poster.jpg?v=15" alt="Poster Menara Berkembar PETRONAS" />
  </div>

  <!-- Reset zoom -->
  <div id="reset" class="reset">Tetap Semula</div>

  <!-- Modal for iOS instruction -->
  <div id="iosModal" class="modal" aria-modal="true" role="dialog" aria-label="Arahan AR iPhone">
    <div class="modal-card">
      <!-- Cube icon (SVG) -->
      <svg viewBox="0 0 24 24"><path d="M12 2L3 7v10l9 5 9-5V7l-9-5zm0 2.18L18.82 7 12 10.82 5.18 7 12 4.18zM5 8.74l6 3.46v6.06l-6-3.34V8.74zm8 9.52v-6.06l6-3.46v6.12l-6 3.4z"/></svg>
      <p>Bagi pengguna iPhone, ketik ikon <strong>AR</strong> berbentuk kiub untuk hidupkan kamera.</p>
      <button id="okBtn">OK</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="hint">Tekan di sini untuk melihat model 3D</div>
    <div class="actions">
      <button id="beginArBtn" class="btn">Mula AR</button>
      <button id="view3dBtn" class="link">Lihat 3D</button>
    </div>
  </footer>

<script>
  // ===== Config =====
  const BASE = 'https://dhukanestapha.github.io/kl-ar';
  const GLB  = BASE + '/assets/petronas_twin_tower.glb';
  const USDZ = BASE + '/assets/PETRONAS_TWIN_TOWER.usdz';
  const HOME = BASE + '/';

  // Detect
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const plat = navigator.platform || '';
  const isIOS = /iPhone|iPad|iPod/i.test(ua) || /iPhone|iPad|iPod/i.test(plat);
  const isAndroid = /Android/i.test(ua);
  const isChrome  = /Chrome\/\d+/i.test(ua) && !/Edg\//i.test(ua);

  // Scene Viewer (Android)
  const enc = encodeURIComponent;
  const sceneViewerHttps = 'https://arvr.google.com/scene-viewer/1.0?file=' + enc(GLB) + '&mode=ar_only&title=' + enc('Menara Berkembar PETRONAS');
  const sceneViewerIntent = 'intent://arvr.google.com/scene-viewer/1.0?file=' + enc(GLB) + '&mode=ar_only&title=' + enc('Menara Berkembar PETRONAS') +
    '#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=' + enc(sceneViewerHttps) + ';end;';

  // UI elements
  const beginBtn = document.getElementById('beginArBtn');
  const view3dBtn = document.getElementById('view3dBtn');
  const iosModal = document.getElementById('iosModal');
  const okBtn = document.getElementById('okBtn');
  const poster = document.getElementById('poster');
  const loader = document.getElementById('loader');

  // ===== Loader: hide when poster is ready (with safety timeout) =====
  function hideLoader(){ loader.classList.add('hide'); setTimeout(()=>loader.style.display='none', 300); }
  if (poster.complete) {
    // If image was cached, complete is true — still give the browser one frame
    requestAnimationFrame(hideLoader);
  } else {
    poster.addEventListener('load', hideLoader);
    poster.addEventListener('error', hideLoader); // don't block UX if poster fails
    // safety: auto-hide after 4s in case of flaky networks
    setTimeout(hideLoader, 4000);
  }

  // ===== AR actions =====
  if (isIOS) {
    // iOS: show instruction modal first; launch Quick Look only after OK
    beginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      iosModal.classList.add('visible');
    });
    okBtn.addEventListener('click', () => {
      iosModal.classList.remove('visible');
      const a = document.createElement('a');
      a.rel = 'ar';
      a.href = USDZ;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  } else if (isAndroid) {
    // Android: go straight to AR
    beginBtn.addEventListener('click', () => {
      const target = isChrome ? sceneViewerIntent : sceneViewerHttps;
      window.location.assign(target);
    });
  } else {
    // Desktop/unknown: go to 3D page
    beginBtn.addEventListener('click', () => window.location.assign(HOME));
  }

  view3dBtn.addEventListener('click', () => window.location.assign(HOME));

  // ===== Pinch-to-zoom & pan =====
  const stage  = document.getElementById('stage');
  const reset  = document.getElementById('reset');
  let scale = 1, minScale = 1, maxScale = 6;
  let tx = 0, ty = 0;
  let startDist = 0, startScale = 1;
  let lastTapTime = 0;
  const pointers = new Map();

  function applyTransform(){ poster.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(${scale})`; }
  function getDistance(p1,p2){ return Math.hypot(p2.x-p1.x, p2.y-p1.y); }
  function clampPan(){ const pad=200; tx=Math.max(-pad,Math.min(pad,tx)); ty=Math.max(-pad,Math.min(pad,ty)); }

  stage.addEventListener('pointerdown', e => { stage.setPointerCapture(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); });
  stage.addEventListener('pointermove', e => {
    if (!pointers.has(e.pointerId)) return;
    const prev = pointers.get(e.pointerId);
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if (pointers.size===2){
      const [a,b]=Array.from(pointers.values()); const dist=getDistance(a,b);
      if (!startDist){ startDist=dist; startScale=scale; }
      scale=Math.max(minScale,Math.min(maxScale,startScale*(dist/startDist)));
    } else if (pointers.size===1 && scale>1){
      tx+=e.clientX-prev.x; ty+=e.clientY-prev.y; clampPan();
    }
    applyTransform();
  });
  function endPointer(e){ pointers.delete(e.pointerId); if (pointers.size<2) startDist=0; }
  stage.addEventListener('pointerup', endPointer);
  stage.addEventListener('pointercancel', endPointer);
  stage.addEventListener('pointerleave', endPointer);

  stage.addEventListener('click', e => {
    const now=Date.now();
    if (now-lastTapTime<300){ if (scale<=1.01){ scale=2; } else { scale=1; tx=0; ty=0; } applyTransform(); }
    lastTapTime=now;
  });
  stage.addEventListener('wheel', e => { e.preventDefault(); const d=-Math.sign(e.deltaY)*0.2; scale=Math.max(minScale,Math.min(maxScale,scale+d)); applyTransform(); }, {passive:false});
  function resetView(){ scale=1; tx=0; ty=0; applyTransform(); }
  reset.addEventListener('click', resetView);
  applyTransform();
</script>
</body>
</html>
